# Malware Analysis Lab 
    A complete beginner's guide to the world of Malware Analysis

<h2>üìùFull Project Overview</h2>
Malware Analysis refers to the process of gathering data and developing a greater understanding of suspicious executables, files, and applications. In the cybersecurity industry, Malware analysis is highly effective as it may help with improving threat detection and alerts, revealing hidden indicators of compromise, and provide further understanding of past exploits to create better defense evasion techniques. 

<br>In this project, we will take a deeper understanding of malware analysis by enhancing comprehension by using real world exposure to malware. Common tools and techniques that practicioners use for malware analysis will be demonstrated throughout the project in order to familiarize oneself with malware analysis in a real-world scenario. Malware analysis labs may be either self-hosted or cloud-hosted, but this in this project specifically a self-hosted lab will be utilized.

<h2>üéØGoals Summarized</h2>
- <b>Learn the key fundamentals of malware analysis as well as developing further understanding of how to detect IOCs</b>
<br>- <b>Develop a greater understanding of the types of malware analysis used</b>
<br>- <b>Investigate samples of malware in a safe, isolated environment to provide real-world exposure to malware analysis</b>
<br>- <b>Investigate how malware communicates with the attacker, and what harmful actions it may carry out towards the infected system</b>

<h2>üîçTypes of Malware Analysis</h2>
<h3>Static Analysis</h3>
* Refers to the process of investigating malware without the need of deploying malware. This technique is used for the extraction of metadata from potentially suspicious files, application, or executables. Typically during static analysis, cybersecurity analysts may extract data such as file names, hashes, strings, IPs, headers, etc.

<h3>Dynamic Analysis</h3>
* Refers to the procedure of running the malware in real-time. This is performed in a sandbox environment, a safe environment made for deploying malware, which is then used by cybersecurity practicioners to examine the effects of the sample in real-time. It provides further understanding into how the malware operates and affects the system as it runs, while also helping cybersecurity practioners develop a greater understanding of functionality and behavior.

<h3>Hybrid Analysis</h3>
* Refers to a combination of both static and dynamic analysis. This is typically used more often compared to the other two methods mentioned above as it provides a much clearer "picture" of the malware as a whole. Malware analysts can review IOCs, while also simultaneously learning the sample's functionality in real-time as it runs.

<h3>Behavior Analysis</h3>
* Process of analyzing malware after it has been executed. Involves monitoring registry entries, network processes, and overall after-effects of the malware after it was executed. 

<h2>üö∂Brief Project Walkthrough</h2>

The project is separated into two parts. In this portion of the project we will:
<br>- <b>Create a virtual machine setup within our host machine</b>
<br>- <b>Create a host-only network so that our machines can communicate with each other</b>
<br>- <b>Utilize the Windows and Linux terminals</b>

<h2>üõ†Ô∏èTools Required</h2>
- Windows 10/11 host OS</b>

<h2>Project Walkthrough</h2>

### Installations
1. Install [VirtualBox](https://www.virtualbox.org/wiki/Downloads)
2. Install [Windows 10 Enterprise](https://info.microsoft.com/ww-landing-windows-10-enterprise.html)
3. Install [REMnux](https://docs.remnux.org/install-distro/get-virtual-appliance)

### Setting up Windows 10 VM
1. Go to VirtualBox -> New. VM requires 60.00GB allocated, but 75.00GB is recommended. Start Windows 10 and attach .iso file.
2. Perform custom installation and partition another disk. Default settings is fine.
![image](https://i.gyazo.com/1b84a7cd7d34640557bee436584b799c.png)

3. Do "domain join instead"
<img src="https://i.gyazo.com/48282d01de4208a66d549cb3eb1071db.png" width="600" height="400">

4. Opt out of all privacy settings.

6. For full screening capability
<img src="https://i.gyazo.com/835af2be536468e1593aea1cc0d0a006.png" width="250" height="200">
Devices -> Insert Guest Additions CD image

Go to "This PC" -> CD Drive Virtualization -> Run "VBoxWindowsAdditions-amd64 -> Reboot

### Setting up FlareVM
7. Install Web Browser of choice on VM
#### Disable Proxy Auto Detect Setting
   8. Windows Search Bar -> proxy settings
   9. Switch "Automatically detect settings" button off
#### Disable Windows Defender
Disable Tamper Protection
<br>10. Search "Defender", open Defender settings and set all Defender Settings to off.

Disable Windows Defender in GPO
<br>11. In the Windows Search Bar, search and select "edit group policy"
<br>12. In GPO, navigate to ‚Üí Administrative Templates ‚Üí Windows Components ‚Üí Microsoft Defender
<br>13. Antivirus ‚Üí Enable ‚ÄúTurn off Microsoft Defender Antivirus‚Äù

Disable Windows Firewall
<br>14. GPO ‚Üí Administrative Templates ‚Üí Network ‚Üí Network Connections ‚Üí Windows Defender
<br>15. Firewall ‚Üí Domain Profile ‚Üí Disable ‚ÄúProtect All Network Connections‚Äù
<br>16. Do the same but for the Standard profile

<b>Take a Snapshot</b>

#### Dowloading + Installing FlareVM
17. Go to powershell, run as administrator
18. Type in <code>cd C:\Users\"username"\Desktop</code>
19. Type in <code>Clear</code>
20. Run <code>(New-Object
net.webclient).DownloadFile('https://raw.githubusercontent.com/mandiant/flarevm/main/install.ps1',"$([Environment]::GetFolderPath("Desktop"))\\install.ps1")</code>
21. Run <code>Unblock-File .\\install.ps1</code>
22. Run <code>Set-ExecutionPolicy Unrestricted</code>. Accept prompt
23. Run <code>.\\install.ps1</code>. Follow prompts and continue with installation.

<b>Take a snapshot</b>

### Setting up REMnux
24. Navigate to file location for REMNux. Double click and launch REMnux instance.

### VirtualBox Network Settings

<br>25. Create new host only network
<br>![Image](https://i.gyazo.com/4fed02fd8efd49c744c6d97b18d162f5.png)

<br>26. Right Click -> Properties. Set IPv4 address to 10.0.0.1. Apply. Now set DHCP server address to 10.0.0.2, lowerbound to 10.0.0.3, upperbound to 10.0.0.254.
<br>![Image](https://i.gyazo.com/48b7b52e6a15fb7e8ee3f48be4230e32.png)

<br>27. Make sure FlareVM and REMnux are both connected to Host-only Adapter, Ethernet Adapter #2 (this will be the one you just created)
<br>![image](https://i.gyazo.com/7c0d2d1385dbacdda6821474d2a62c9c.png)

### Creating a fake network in REMnux

28. Navigate to REMnux terminal
29. Run <code>inetsim</code> in terminal to start network service
30. Run <code>cd /etc/inetsim</code>
31. Run <code>sudo nano inetsim.conf</conf></code>
- Uncomment <code>start_service dns</code>
- Set <code>service_bind_address</code> to 0.0.0.0
- Set the DNS Default IP to IP address of RemNUX VM Address (10.0.0.4)
- Save and Exit from inetsim.conf

### Configuring Network Settings in Windows 10 FlareVM
32. Windows Search Bar -> Ethernet settings -> change adapter options -> Right click ethernet -> properties -> Internet Protocol Version 4 -> Properties -> Use the following DNS server addresses: 10.0.0.4

### Windows Firewall Inbound Rule
1. Windows Defender Firewall -> Advanced Settings > Inbound Rule -> New Rule -> Custom -> Next, all programs -> Next, leave default protocol and ports -> next. 

### Pinging the Addresses
1. In Windows 10 FlareVM powershell, enter <code>ping 10.0.0.4</code>. You should be able to ping the REMnux address (10.0.0.4)
2. In REMNux terminal, enter <code>ping 10.0.0.3</code>

### Pinging the Address v2
1. If pinging is not working, check the addresses of each VM.
2. In Windows 10 FlareVM powershell, type <code>ipconfig</code>. This will bring up your IP address. Take note of the IP address in FlareVm
3. In REMnux terminal, type <code>ifconfig</code>. Take note of the IP address that appears next to "inet".
4. In REMnux terminal, type <code>ping "flareVM IP"</code>. REMnux will ping the IP address for your FlareVM machine
5. In FlareVM powershell, type <code>ping "REMnux IP"</code>. FlareVM will ping the IP address for your REMnux machine.

<b>Take a snapshot of FlareVM</b>

You have now set up your own personal malware lab. In the next part, we will begin the malware analysis procedure.
































